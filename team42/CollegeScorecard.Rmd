---
title: "CollegeScorecardData"
output: 
  html_document: 
    fig_height: 6
    fig_width: 10
---
Authors: Josh, Becky, Erin

```{r, message=FALSE}
require("doBy")
source("funcs.R")
require("tidyr")
require("ggplot2")
#install.packages("ggmap")
#install.packages("maps")
require("ggmap")
require("maps")
#make a symlink from the data dir in the directory where this file is to the desired data file
datafile <- "data/merged.csv"
```

### Read the data

Initially, we read the data and preserve any entries that are "PrivacySuppressed". We will treat these as NAs in our analysis further forward, but we keep them initially to assess the quality of the data.

```{r, cache=TRUE}
college.df <- read.csv(datafile, header = TRUE, na.strings = c("NULL"))
```

#### Missing data

What is the ratio of NAs to non-NAs overall? 

(Note that NA includes only "Null" - not "PrivacySuppressed".)
```{r}
na.columns <- is.na(college.df)
not.na.columns <- !is.na(college.df)

sum(na.columns)/sum(not.na.columns)
```


#### PrivacySuppressed

Now let's look at columns containing "PrivacySuppressed".

```{r}
# this leaves NA as NA (and not 1 or 0)
priv.supp.bool <- ifelse(college.df == "PrivacySuppressed", 1, 0)
not.priv.supp.bool <- ifelse(college.df == "PrivacySuppressed", 0, 1)

priv.supp.count <- sum(priv.supp.bool, na.rm = TRUE)
not.priv.supp.count <- sum(not.priv.supp.bool, na.rm = TRUE)
```

Here is the ratio of "privacy suppressed" elements to non-"privacy suppressed" elements. NAs are not included in either category.
```{r}
priv.supp.count/not.priv.supp.count
```


#### Overall column-wise analysis:

This includes NA counts and ratios, and counts of "PrivacySuppressed".
```{r}
col.na.ratios <- colSums(na.columns)/colSums(not.na.columns)
col.max.na <- c(max(col.na.ratios), nrow(college.df), which.max(col.na.ratios))
names(col.max.na) <- c("number of NAs", "number of rows", "column name")

col.na <- data.frame(na.count = colSums(na.columns),
                     row.count = nrow(college.df))
col.na$na.ratio <- with(col.na,na.count/(row.count - na.count))
col.na$na.fraction <- with(col.na,na.count/row.count)
col.na$priv.count <- colSums(priv.supp.bool, na.rm = TRUE)
col.na$priv.fraction <- with(col.na,priv.count/row.count)

col.na.most <- col.na[order(col.na$na.ratio,decreasing=TRUE),]
col.na.least <- col.na[order(col.na$na.ratio,decreasing=FALSE),]
col.priv.most <- col.na[order(col.na$priv.count,decreasing=TRUE),]
col.priv.least <- col.na[order(col.na$priv.count,decreasing=FALSE),]
```

Columns with the most NAs:
```{r}
head(col.na.most)
```

Columns with the least NAs:
```{r}
head(col.na.least)
```

And columns with the most "PrivacySuppressed" elements:
```{r}
head(col.priv.most)
```

Histogram of fractions of NAs:
```{r, echo=FALSE}
hist(col.na$na.fraction)
```

Histogram of fractions of PrivacySuppressed elements:
```{r, echo=FALSE}
hist(col.na$priv.fraction)
```

Ratio of columns with no "PrivacySuppressed"s to those with "PrivacySuppressed":
```{r}
sum(col.na$priv.count == 0)/sum(col.na$priv.count != 0)
```

Ratio of columns with no NAs to those with NAs:
```{r}
sum(col.na$na.count == 0)/sum(col.na$na.count != 0)
```

### Analysis

We reread the data considering "PrivacySuppressed" as NA:
```{r}
rm(college.df)
col.df <- read.csv(datafile, header = TRUE, na.strings = c("NULL", "PrivacySuppressed"))
```

#### Exploration

And we begin to explore. What state pays its faculty the most?

```{r}
ggplot(col.df, aes(x = STABBR, y = AVGFACSAL)) + geom_boxplot() + xlab("State") + ylab("Avg monthly salary")
```

Here is a plot of the percentage of full time faculty by state:

```{r}
ggplot(col.df, aes(x = STABBR, y = PFTFAC)) + geom_boxplot() + xlab("State") + ylab("Percentage full time faculty")
```

Are there any regions in the US where schools tend to have more full time faculty?
```{r}
map<-get_map(location='united states', zoom=4, maptype = "terrain", source='google',color='color')
ggmap(map) + geom_point(
     aes(x=LONGITUDE, y=LATITUDE, show_guide = TRUE, colour=PFTFAC), 
     data=col.df, na.rm = T)  + 
     scale_color_gradient(low="beige", high="blue")
```


Turning now to the students: what is the percentage of students making > $25000/yr after 6,7,8,9 and 10 years of school?
```{r}
colMeans(col.df[,grep("^gt_25k*", colnames(col.df))], na.rm = TRUE)
```

#### Visualizing

We started by looking at the relationship between the percentage of first-generation students, faculty salaries and percentage of students making > 25k/year:
```{r}
qplot(y=gt_25k_p10, x=AVGFACSAL, size = FIRSTGEN_YR4_N/(FIRSTGEN_YR4_N+ NOT1STGEN_YR4_N), data = col.df)
```

The image suggests there is some correlation. We wanted to see if we could break this up into further components: school tuition, type of school ("traditional" or "non-traditional"), predominant degree awarded and control of the school (public, for-profit and not-for-profit). 

We start by binning the tuition fee into three categories: 
```{r}
col.df$TUITFTE.bin <- cut(col.df$TUITFTE, quantile(col.df$TUITFTE, c(0,.25,.75,1), na.rm = TRUE), labels = c("low tuition", "interquartile", "high tuition"))
```

Then, we find the ratio of first-generation students to non-first-generation students. We combine two columns to do so, and again bin into three categories.
```{r}
col.df$FIRSTGEN.ratio <- with(col.df, FIRSTGEN_YR4_N/(FIRSTGEN_YR4_N+ NOT1STGEN_YR4_N))
col.df$FIRSTGEN.bin <- with(col.df, cut(FIRSTGEN.ratio, quantile(FIRSTGEN.ratio, seq(0,1,.25), na.rm = TRUE), labels = paste0(seq(25, 100, 25), "%ile")))
```

We bin the predominant degree awarded into two categories: traditional and non-traditional. If the school offers bredominantly bachelor's and grad degrees, we consider it to be a traditional school. Otherwise, we consider it to be non-traditional.
```{r}
col.df$PREDDEG.bin <- factor(ifelse(col.df$PREDDEG < 3,"Non-trdl","Trdl"))
```

And we create a new class combining control of the school (public, not-for-profit, for-profit) with the predominant degree awarded (traditional, non-traditional).
```{r}
col.df$PRED.CTRL <- paste(
                      col.df$PREDDEG.bin, 
                      factor(
                          ifelse(
                            col.df$CONTROL == 1, 
                            "Public",
                            ifelse(
                              col.df$CONTROL == 2, 
                              "Nonprofit",
                              # JOSH: check for NAs here
                              "For profit"
                            )
                          )
                        )
                    )

#JOSH: check point size
#JOSH: any chance we can change the FIRSTGEN.bin label?
```

And lastly, we visualize!
```{r, message=FALSE,warning=FALSE}
qplot(
  y=gt_25k_p10, 
  x=AVGFACSAL, 
  data = col.df, 
  facets = TUITFTE.bin ~ PRED.CTRL,
  xlab = "Avg Faculty Salary", 
  ylab = "Students Earning > $25K After 10 Yrs"
) + geom_point(size=3, aes(colour = FIRSTGEN.bin)) 
```

