---
title: "CollegeScorecard"
output: html_document
---

```{r}
require("doBy")
source("funcs.R")
require("tidyr")
#make a symlink from the data dir in the directory where this file is to the desired data file
datafile <- "data/merged.csv"
```


```{r, cache=TRUE}
college.df <- read.csv(datafile, header = TRUE, na.strings = c("NULL"))
```

#### NA

What is the ratio of NAs to non-NAs overall? (Note that NA includes only "Null" - not "PrivacySuppressed".)
```{r, cache=TRUE}
na.columns <- is.na(college.df)
not.na.columns <- !is.na(college.df)

sum(na.columns)/sum(not.na.columns)
```

Roughly 75%. 

Which column has the most NAs, and how many are there?

```{r}
col.na.ratios <- colSums(na.columns)/colSums(not.na.columns)
col.max.na <- c(max(col.na.ratios), nrow(college.df), which.max(col.na.ratios))
names(col.max.na) <- c("number of NAs", "number of rows", "column name")

col.na <- data.frame(na.count = colSums(na.columns),
                     row.count = nrow(college.df))
col.na$na.ratio <- with(col.na,na.count/(row.count - na.count))
col.na$na.fraction <- with(col.na,na.count/row.count)
col.na$priv.count <- colSums(ifelse(!is.na(college.df) & college.df == "PrivacySuppressed",1,0))

col.na.most <- col.na[order(col.na$na.ratio,decreasing=TRUE),]
col.na.least <- col.na[order(col.na$na.ratio,decreasing=FALSE),]
col.priv.most <- col.na[order(col.na$priv.count,decreasing=FALSE),]
head(col.na.most)
head(col.na.least)
head(col.priv.most)
```

```{r, echo=FALSE}
hist(col.na$na.fraction)
```

So the NAs compose .05% of the rows in this column. Not terrible.

Which has the fewest NAs?

```{r}
col.min.na <- c(min(col.na.ratios), nrow(college.df), which.min(col.na.ratios))
names(col.min.na) <- c("number of NAs", "number of rows", "column name")

col.min.na
```

There are columns with no NAs at all. How many?

```{r}
length(college.df[,col.na.ratios == 0])
```


#### PrivacySuppressed

Now let's look at columns containing "PrivacySuppressed".

```{r, cache = TRUE}
# this leaves NA as NA (and not 1 or 0)
priv.supp.bool <- ifelse(college.df == "PrivacySuppressed", 1, 0)
not.priv.supp.bool <- ifelse(college.df == "PrivacySuppressed", 0, 1)

priv.supp.count <- sum(priv.supp.bool, na.rm = TRUE)
not.priv.supp.count <- sum(not.priv.supp.bool, na.rm = TRUE)
```

Note that this just counts the columns that do not contain NA. 

Here is the ratio of columns containing "privacy suppressed" to those without:

```{r}
priv.supp.count/not.priv.supp.count
```

About 50%. Which column has the most "privacy suppressed" entries?

```{r}
col.ps.ratios <- colSums(priv.supp.columns)/colSums(not.priv.supp.columns)
col.max.ps <- c(max(col.ps.ratios), nrow(college.df), which.max(col.ps.ratios))
names(col.max.ps) <- c("number of NAs", "number of rows", "column name")

col.max.ps
```


#### Looking forward.... this code is remarkably rough.

```{r}
head(
  summaryBy(
    FEMALE_COMP_ORIG_YR4_RT + FEMALE_COMP_ORIG_YR3_RT + FEMALE_COMP_ORIG_YR2_RT + FEMALE_COMP_ORIG_YR6_RT + FEMALE_COMP_ORIG_YR8_RT ~ region + PREDDEG, 
    data=college.df,
    FUN=function(x) {c(m =mean(x, na.rm = TRUE),s =sd(x, na.rm = TRUE)) }
    )
)
```

```{r}
c2 <- college.df
names(c2) <- rename_by_yaml(c2,"data/data_dictionary.yaml")

#c2 <- c2[,! grepl("school",names(c2)) & !grepl("location",names(c2))]
#kvs <- gather(c2,key=k,value=v,-X,-YEAR,-X.UNITID,-ope8_id,-ope6_id)
#kvs <- separate(kvs,k,into=c("p1","p2","p3"),sep=".",extra="merge")
```
